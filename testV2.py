import torch
from transformers import AutoTokenizer, AutoModelForCausalLM

# 设置设备，自动分配到多个GPU上
device_map = "auto"  # 使用自动设备映射

model_path = "/workspace/dujh22/models/mistral-7B-sft"
tokenizer = AutoTokenizer.from_pretrained(model_path)

# 加载模型时使用混合精度和设备映射
model = AutoModelForCausalLM.from_pretrained(
    model_path, 
    torch_dtype=torch.bfloat16,  # 使用bfloat16来加速计算
    device_map=device_map        # 使用自动设备映射
)

# 检查模型是否正确加载到设备
print(model.device)

# 输入数据
device = "cuda:0"  # 设置主GPU
while True:
    text = '''以下是一个专注于大模型深度推理的复杂 prompt，旨在生成复杂的逻辑推理问题，涉及多个层次的推理步骤和知识融合：

示例复杂 Prompt：

背景信息：

假设你是一位高级人工智能研究员，致力于开发能够进行深度推理的大型语言模型。你的目标是生成具有挑战性的、需要多步骤推理的问题，涉及数学推理、因果关系推断、模糊逻辑、概率推理以及情境推理等方面。为了实现这一目标，你需要基于现实世界的复杂情境，构建出能够考察模型推理能力的多步骤推理问题。

问题要求：
	1.	多层次逻辑推理：
	•	每个问题应要求模型进行至少三层的推理，涉及从基本事实推导到结论的多个步骤。问题应该包含嵌套的因果关系、相互依赖的假设、概率推理等。
	•	问题的设计应具有递进性，需要模型根据前提逐步得出结论，并考虑可能的反向推理。
	2.	数学推理：
	•	包含需要进行复杂数学推理的问题，可能涉及数列、概率论、集合论、函数、图论、逻辑运算等知识。
	•	每个问题应设计一个具有实际应用背景的情境，模型需要根据已知条件进行计算或推导。
	3.	情境推理：
	•	构建问题时，应考虑复杂的情境设置，要求模型根据给定的背景信息进行推理。例如，模型可能需要推测某个事件的潜在原因，或预测某种趋势的发展。
	•	情境推理问题可以涉及环境变化、社会动态或科学实验等领域。
	4.	因果推理：
	•	设计问题时，要求模型理解并推断出事件之间的因果关系。例如，给定一系列的观察结果，模型应能够推测出可能的因果链条，并做出预测。
	•	结合已知事实，设计问题时应保证因果关系的合理性和连贯性。
	5.	模糊逻辑与不确定性：
	•	问题应设计成包含模糊信息或不确定性（例如，概率分布、模糊集合等），要求模型基于不完全信息进行推理。
	•	模型应能够处理模糊数据，并推导出合理的结论。
	6.	知识融合：
	•	问题应涉及多个领域的知识，要求模型能够跨学科整合信息进行推理。例如，涉及物理、经济学、心理学、环境科学等领域的知识。
	•	需要模型识别不同领域之间的联系，并利用跨领域的知识进行推理。

任务要求：
	1.	问题生成：
	•	系统需要生成具有高度复杂性的逻辑推理问题。这些问题应根据多层推理、复杂数学公式和多领域知识来构建。
	•	每个问题应涉及不同的推理类型，如数学推理、因果推理、概率推理等。
	2.	推理过程：
	•	在每个问题中，系统不仅要给出问题本身，还应提供推理的每个步骤。每个推理步骤应展示模型如何从已知信息推导到最终结论。
	•	推理过程应包括对每一步的详细解释，特别是在处理模糊信息或多种假设时。
	3.	情境和复杂度：
	•	问题应设计得足够复杂，要求模型理解复杂的情境背景，并从多个维度进行推理。
	•	每个问题的背景信息应足够详细，以保证模型可以充分理解情境，进行多轮推理。

示例问题：
	1.	推理问题 1：
在一个密闭空间内，一只小猫被锁在一个房间里，房间内有一扇窗子，但窗子被牢固地封住。房间内的温度逐渐上升，空气中的氧气开始逐渐减少。猫的生理反应显示它感到越来越不适。
问题：假设猫的生理反应与氧气含量成反比，且房间温度每分钟上升 1°C，氧气消耗量每分钟增加 2%（初始氧气含量为 21%），猫的舒适度随着氧气含量下降而降低。请推理并计算，猫在多少分钟后将感到极度不适（舒适度为0），并给出导致这一结果的关键因素。
	2.	推理问题 2：
假设你有一个数据集，其中包含了不同城市的犯罪率、经济水平、教育水平等变量。你知道犯罪率受多种因素影响，包括经济状况、教育水平、政府政策等。
问题：如果某个城市的经济状况较差，但教育水平较高，且政府实施了一项新的社会福利政策，推理该城市的犯罪率是会增加还是减少？请根据逻辑推理给出具体的原因，并阐明经济、教育和政策如何相互作用，影响犯罪率的变化。
	3.	推理问题 3：
在一个实验中，你向一组受试者展示了一些图片，其中一些图片包含令人不安的内容，而另一些则是中性或愉快的内容。实验结果显示，受试者在观看令人不安的图片时，情绪波动更大，并且他们更倾向于做出激烈的反应。
问题：请推理并解释，为什么不同类型的图片会对受试者产生不同的情绪反应？考虑心理学和神经科学的相关知识，分析情绪反应的生理机制，并讨论如何利用这些反应来预测受试者的行为。
	4.	推理问题 4：
一家公司在过去的五年内每年都投资于市场营销和广告。最近，公司决定停止在广告上的投资，并转而增加研发投入。你被要求评估这种战略变化对公司长期增长的影响。
问题：根据历史数据和经济学原理，推理这项策略变动对公司未来增长的潜在影响，并分析其可能的风险和回报。你需要考虑不同领域的影响，包括市场需求、技术创新、品牌影响力等。

说明：

这些问题综合了多个领域的知识和复杂的推理步骤。每个问题都包含了层层递进的推理要求，要求模型从初步条件出发，经过多次推理，最终得出结论。这类问题既考验了大模型在逻辑推理上的深度，也挑战了其跨学科知识融合的能力。'''
    inputs = tokenizer(text, return_tensors="pt").to(device)  # 将输入数据移动到主GPU

    # 调整生成参数以确保负载均衡
    outputs = model.generate(
        **inputs, 
        max_new_tokens=2048, 
        do_sample=True, 
        num_return_sequences=1,
        temperature=1.0,
        top_p=0.95
    )

    # 解码并打印输出
    print(tokenizer.decode(outputs[0], skip_special_tokens=True))